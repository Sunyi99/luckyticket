<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åŒè‰²çƒæ™ºèƒ½åˆ†æä¸æ¨èå·¥å…·</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #d32f2f;
    }
    textarea {
      width: 100%;
      height: 120px;
      margin: 8px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: monospace;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    button {
      background-color: #1976d2;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
    }
    button:hover {
      background-color: #1565c0;
    }
    button#recommendBtn {
      background-color: #388e3c;
    }
    button#recommendBtn:hover {
      background-color: #2e7d32;
    }
    .result {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin: 10px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .best {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
    }
    .recommend-section {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    pre {
      background: #f1f1f1;
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
  </style>
</head>
<body>

<h1>ğŸ¯ åŒè‰²çƒæ™ºèƒ½åˆ†æä¸æ¨èå·¥å…·</h1>

<div class="label">ğŸ“Œ ä½ çš„æŠ•æ³¨å·ç ï¼ˆæ¯è¡Œä¸€ç»„ï¼Œæ ¼å¼ï¼š02 09 15 18 24 29 + 06ï¼‰</div>
<textarea id="myTickets" placeholder="ä¾‹å¦‚ï¼š
02 09 15 18 24 29 + 06
05 11 13 22 27 31 + 14"></textarea>

<div class="label">ğŸ“… å†å²å¼€å¥–æ•°æ®ï¼ˆè‡³å°‘20æœŸï¼Œç”¨äºåˆ†æï¼‰</div>
<textarea id="historyData" placeholder="ä»å½©ç¥¨ç½‘ç«™å¤åˆ¶å†å²å¼€å¥–æ•°æ®..."></textarea>

<div class="btn-group">
  <button onclick="analyze()">ğŸ” åˆ†ææˆ‘çš„å·ç </button>
  <button id="recommendBtn" onclick="generateSmartCombos()">âœ¨ æ™ºèƒ½æ¨èé«˜è¯„åˆ†ç»„åˆ</button>
</div>

<div id="output"></div>

<script>
// ========== å…¬å…±è§£æå‡½æ•° ==========
function parseLines(text) {
  const lines = text.trim().split('\n').filter(line => line.trim());
  const pattern = /(\d{1,2})\s+(\d{1,2})\s+(\d{1,2})\s+(\d{1,2})\s+(\d{1,1})\s+(\d{1,2})\s*\+\s*(\d{1,2})/;
  const result = [];
  for (const line of lines) {
    const match = line.match(/(\d{1,2})/g);
    if (match && match.length >= 7) {
      const nums = match.slice(0, 6).map(x => parseInt(x, 10));
      const blue = parseInt(match[6], 10);
      if (nums.every(n => n >= 1 && n <= 33) && blue >= 1 && blue <= 16) {
        const unique = [...new Set(nums)];
        if (unique.length === 6) {
          result.push({ reds: unique.sort((a,b)=>a-b), blue });
        }
      }
    }
  }
  return result;
}

// ========== è¯„åˆ†å‡½æ•° ==========
function scoreTicket(ticket, history) {
  const reds = ticket.reds;
  const blue = ticket.blue;

  const oddCount = reds.filter(x => x % 2 === 1).length;
  const small = reds.filter(x => x <= 17).length;
  const zone1 = reds.filter(x => x >= 1 && x <= 11).length;
  const zone2 = reds.filter(x => x >= 12 && x <= 22).length;
  const zone3 = reds.filter(x => x >= 23 && x <= 33).length;

  let totalRedMatch = 0, totalBlueMatch = 0;
  if (history && history.length > 0) {
    for (const h of history) {
      totalRedMatch += reds.filter(r => h.reds.includes(r)).length;
      if (blue === h.blue) totalBlueMatch++;
    }
  }

  const avgRedMatch = history?.length ? (totalRedMatch / history.length) : 0;
  const blueHitRate = history?.length ? (totalBlueMatch / history.length) : 0;

  let score = 0;
  if ([2,3,4].includes(oddCount)) score += 10;
  if ([2,3,4].includes(small)) score += 10;
  if (zone1 >= 1 && zone2 >= 1 && zone3 >= 1) score += 15;
  score += Math.min(avgRedMatch * 8, 20);
  score += Math.min(blueHitRate * 100 * 0.15, 15); // è“çƒæœ€å¤š15åˆ†

  return {
    ...ticket,
    oddCount, evenCount: 6 - oddCount,
    small, large: 6 - small,
    zone1, zone2, zone3,
    avgRedMatch: avgRedMatch.toFixed(2),
    blueHitRate: (blueHitRate * 100).toFixed(1),
    score: parseFloat(score.toFixed(1))
  };
}

// ========== éšæœºç”Ÿæˆåˆè§„çº¢çƒ ==========
function generateReds() {
  const reds = new Set();
  while (reds.size < 6) {
    reds.add(Math.floor(Math.random() * 33) + 1);
  }
  return Array.from(reds).sort((a, b) => a - b);
}

// ========== ç”Ÿæˆæ™ºèƒ½ç»„åˆ ==========
function generateSmartCombos() {
  const historyText = document.getElementById('historyData').value;
  const history = parseLines(historyText);
  const hasHistory = history && history.length >= 10; // è‡³å°‘10æœŸæ‰å¯ç”¨å†å²åŒ¹é…

  // åŠ¨æ€è®¾å®šé˜ˆå€¼
  const threshold = hasHistory ? 50 : 40;

  // æ”¶é›†æ‰€æœ‰çº¢çƒå’Œè“çƒé¢‘ç‡ï¼ˆç”¨äºåŠ æƒï¼‰
  let redFreq = {};
  let blueFreq = {};
  if (hasHistory) {
    for (const h of history) {
      for (const r of h.reds) redFreq[r] = (redFreq[r] || 0) + 1;
      blueFreq[h.blue] = (blueFreq[h.blue] || 0) + 1;
    }
  }

  // æ„é€ é«˜æ¦‚ç‡çº¢çƒæ± ï¼ˆçƒ­å· + å‡åŒ€åˆ†å¸ƒï¼‰
  function generateStructuredReds() {
    const reds = new Set();

    // å¼ºåˆ¶æ¯ä¸ªåŒºé—´é€‰1ï½3ä¸ª
    const zones = [
      Array.from({length:11}, (_,i)=>i+1),      // 1-11
      Array.from({length:11}, (_,i)=>i+12),     // 12-22
      Array.from({length:11}, (_,i)=>i+23)      // 23-33
    ];

    // æ¯ä¸ªåŒºé—´è‡³å°‘é€‰1ä¸ªï¼Œæœ€å¤š3ä¸ªï¼Œæ€»å…±6ä¸ª
    let counts = [1,1,1];
    let remaining = 3;
    while (remaining > 0) {
      const idx = Math.floor(Math.random() * 3);
      if (counts[idx] < 3) {
        counts[idx]++;
        remaining--;
      }
    }

    // ä»æ¯ä¸ªåŒºé—´æŒ‰é¢‘ç‡æˆ–éšæœºé€‰
    for (let z = 0; z < 3; z++) {
      const pool = [...zones[z]];
      // å¦‚æœæœ‰å†å²ï¼Œä¼˜å…ˆé€‰é«˜é¢‘å·
      if (hasHistory) {
        pool.sort((a,b) => (blueFreq[b] || 0) - (blueFreq[a] || 0));
      }
      for (let i = 0; i < counts[z]; i++) {
        let candidate;
        do {
          candidate = pool[Math.floor(Math.random() * Math.min(5, pool.length))];
        } while (reds.has(candidate));
        reds.add(candidate);
      }
    }

    return Array.from(reds).sort((a,b)=>a-b);
  }

  const candidates = [];
  const maxAttempts = 500;

  for (let i = 0; i < maxAttempts; i++) {
    const reds = generateStructuredReds();
    // è“çƒï¼šä¼˜å…ˆé€‰å†å²é«˜é¢‘ï¼Œå¦åˆ™éšæœº
    let blue;
    if (hasHistory && Object.keys(blueFreq).length > 0) {
      const sortedBlues = Object.entries(blueFreq).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);
      blue = parseInt(sortedBlues[Math.floor(Math.random()*sortedBlues.length)]);
    } else {
      blue = Math.floor(Math.random() * 16) + 1;
    }

    const ticket = { reds, blue };
    const scored = scoreTicket(ticket, hasHistory ? history : null);
    if (scored.score >= threshold) {
      candidates.push(scored);
    }
    if (candidates.length >= 10) break;
  }

  if (candidates.length === 0) {
    // æœ€åæ‰‹æ®µï¼šæ”¾å®½æ¡ä»¶ï¼Œè¿”å›æœ€é«˜åˆ†çš„3ç»„
    const fallback = [];
    for (let i = 0; i < 200; i++) {
      const reds = generateStructuredReds();
      const blue = Math.floor(Math.random() * 16) + 1;
      fallback.push(scoreTicket({reds, blue}, hasHistory ? history : null));
    }
    fallback.sort((a,b)=>b.score-a.score);
    candidates.push(...fallback.slice(0,3));
  }

  // å–å‰3
  const top3 = candidates.slice(0, 3).sort((a,b)=>b.score-a.score);

  let html = `<div class="recommend-section"><h3>ğŸŒŸ æ™ºèƒ½æ¨èç»„åˆï¼ˆè¯„åˆ† â‰¥${threshold}ï¼‰</h3>`;
  top3.forEach((res, i) => {
    const fmtReds = res.reds.map(n => n.toString().padStart(2, '0')).join(' ');
    const fmtBlue = res.blue.toString().padStart(2, '0');
    html += `
      <div class="result best">
        <strong>æ¨è ${i+1}ï¼ˆè¯„åˆ†: ${res.score}/70ï¼‰</strong><br>
        ${fmtReds} + ${fmtBlue}<br>
        å¥‡å¶:${res.oddCount}:${res.evenCount} | å¤§å°:${res.small}:${res.large} | åŒºé—´:${res.zone1}-${res.zone2}-${res.zone3}
      </div>
    `;
  });
  html += `</div>`;

  document.getElementById('output').innerHTML = html;
}

// ========== åˆ†æç”¨æˆ·è¾“å…¥ ==========
function formatNums(nums) {
  return nums.map(n => n.toString().padStart(2, '0')).join(' ');
}

function analyze() {
  const myText = document.getElementById('myTickets').value;
  const histText = document.getElementById('historyData').value;

  const myTickets = parseLines(myText);
  const history = parseLines(histText);

  if (myTickets.length === 0) {
    alert("è¯·æ­£ç¡®è¾“å…¥ä½ çš„æŠ•æ³¨å·ç ï¼");
    return;
  }

  const results = myTickets.map(t => scoreTicket(t, history));
  const bestScore = Math.max(...results.map(r => r.score));
  
  let html = `<h2>ğŸ“Š ä½ çš„å·ç åˆ†æç»“æœï¼ˆå…± ${results.length} ç»„ï¼‰</h2>`;
  results.forEach((res, i) => {
    const isBest = res.score === bestScore;
    html += `
      <div class="result ${isBest ? 'best' : ''}">
        <strong>ã€ç¬¬${i+1}ç»„ã€‘</strong><br>
        å·ç : ${formatNums(res.reds)} + ${res.blue.toString().padStart(2, '0')}<br>
        å¥‡å¶æ¯”: ${res.oddCount}:${res.evenCount} | å¤§å°æ¯”: ${res.small}:${res.large}<br>
        åŒºé—´åˆ†å¸ƒ: ${res.zone1}-${res.zone2}-${res.zone3}ï¼ˆç†æƒ³ï¼š2-2-2ï¼‰<br>
        å¹³å‡çº¢çƒé‡åˆæ•°: ${res.avgRedMatch} | è“çƒå‘½ä¸­ç‡: ${res.blueHitRate}%<br>
        â­ ç»¼åˆè¯„åˆ†: <strong>${res.score}/70</strong>
      </div>
    `;
  });

  document.getElementById('output').innerHTML = html;
}
</script>

</body>
</html>